<?xml version="1.0" encoding="UTF-8"?>
<!-- The name of the product -->
<?define Name = "Invinsense" ?>
<!-- The Description of the product -->
<?define Description = "Invinsense 3.0 Agent" ?>
<!-- The manufacturer, for setup package publisher and folder info -->
<?define Manufacturer = "Infopercept" ?>
<!-- The manufacturer, for AgentPackege and folder info -->
<?define AgentName = "IvsAgent" ?>
<!-- The manufacturer, for TrayPackage and folder info -->
<?define TrayName = "IvsTray" ?>
<!-- The manufacturer, for other tools and folder info -->
<?define ArtifactsName = "Artifacts" ?>
<!-- The version number of this setup package-->
<?define Version = "1.0.0" ?>
<!-- UpgradeCode must be unique and not changed once the first version of the program is installed. -->
<?define UpgradeCode = "{38ECE878-1645-4310-BD9A-B9CA57FE0DF0}" ?>
<!-- The name of the Cabinet -->
<?define CabName = "Invinsense.cab" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!--Variable for Agent Service Directory-->
	<?define Agent_Service_TargetDir=$(var.IvsAgent.TargetDir)?>

	<!--Variable for Sample Application Directory-->
	<?define Tray_Application_TargetDir=$(var.IvsTray.TargetDir)?>

	<Product Id="*" Name="$(var.Name)" Manufacturer="$(var.Manufacturer)" UpgradeCode="$(var.UpgradeCode)" Version="$(var.Version)" Language="1033">

		<!--Setup or Installer with properties-->
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Manufacturer="$(var.Manufacturer)" Platform="x64"/>

		<!-- Allow upgrades and prevent downgrades -->
		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

		<!--Embed Cabinet into single msi file-->
		<MediaTemplate EmbedCab="yes" />

		<!--Main Feature for this Setup which can be found in Fragment Tag with ComponentGroupRef Id-->
		<Feature Id="ProductFeature" Title="$(var.Name)" Level="1">
			<ComponentGroupRef Id="DbComponents" />
			<ComponentGroupRef Id="AgentComponents" />
			<ComponentGroupRef Id="TrayComponents" />
			<ComponentGroupRef Id="ToolComponents" />
			<ComponentGroupRef Id="PostInstallation"/>
		</Feature>
		
	</Product>

	<!--Fragment with details of installation directory-->
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFiles64Folder">
				<Directory Id="ManufacturerFolder" Name="!(bind.property.Manufacturer)">
					<Directory Id="AGENTFOLDER" Name="$(var.AgentName)" />
					<Directory Id="TRAYFOLDER" Name="$(var.TrayName)" />
					<Directory Id="ARTIFACTSFOLDER" Name="$(var.ArtifactsName)" />
				</Directory>
			</Directory>
		</Directory>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="DbComponents" Directory="ManufacturerFolder">
			<Component Id="d00" Guid="648BA540-9CBC-4A05-A3D1-4016437DB870" Win64="yes">
				<File Id="d02" Source="..\artifacts\db" />
			</Component>
		</ComponentGroup>
	</Fragment>
	
	<Fragment>
		<ComponentGroup Id="AgentComponents" Directory="AGENTFOLDER">
			<Component Id="a00" Guid="380bbddd-daa7-0744-517b-37da768f5570" Win64="yes">
				<File Id="a02" Source="$(var.Agent_Service_TargetDir)\event_descriptions.json" />
				<File Id="a03" Source="$(var.Agent_Service_TargetDir)\Common.dll" />
				<File Id="a04" Source="$(var.Agent_Service_TargetDir)\Common.dll.config" />
				<File Id="a05" Source="$(var.Agent_Service_TargetDir)\Common.pdb" />
				<File Id="a06" Source="$(var.IvsAgent.TargetPath)" />
				<File Id="a07" Source="$(var.Agent_Service_TargetDir)\IvsAgent.exe.config" />
				<File Id="a08" Source="$(var.Agent_Service_TargetDir)\IvsAgent.pdb" />
				<File Id="a09" Source="$(var.Agent_Service_TargetDir)\LiteDB.dll" />
				<File Id="a10" Source="$(var.Agent_Service_TargetDir)\LiteDB.xml" />
				<File Id="a11" Source="$(var.Agent_Service_TargetDir)\Microsoft.Bcl.AsyncInterfaces.dll" />
				<File Id="a12" Source="$(var.Agent_Service_TargetDir)\Microsoft.Bcl.AsyncInterfaces.xml" />
				<File Id="a13" Source="$(var.Agent_Service_TargetDir)\Microsoft.Deployment.WindowsInstaller.dll" />
				<File Id="a14" Source="$(var.Agent_Service_TargetDir)\Microsoft.Deployment.WindowsInstaller.xml" />
				<File Id="a15" Source="$(var.Agent_Service_TargetDir)\MsiWrapper.dll" />
				<File Id="a16" Source="$(var.Agent_Service_TargetDir)\MsiWrapper.pdb" />
				<File Id="a17" Source="$(var.Agent_Service_TargetDir)\Serilog.dll" />
				<File Id="a18" Source="$(var.Agent_Service_TargetDir)\Serilog.Sinks.File.dll" />
				<File Id="a19" Source="$(var.Agent_Service_TargetDir)\Serilog.Sinks.File.pdb" />
				<File Id="a20" Source="$(var.Agent_Service_TargetDir)\Serilog.Sinks.File.xml" />
				<File Id="a21" Source="$(var.Agent_Service_TargetDir)\Serilog.xml" />
				<File Id="a22" Source="$(var.Agent_Service_TargetDir)\System.Buffers.dll" />
				<File Id="a23" Source="$(var.Agent_Service_TargetDir)\System.Buffers.xml" />
				<File Id="a24" Source="$(var.Agent_Service_TargetDir)\System.Memory.dll" />
				<File Id="a25" Source="$(var.Agent_Service_TargetDir)\System.Memory.xml" />
				<File Id="a26" Source="$(var.Agent_Service_TargetDir)\System.Numerics.Vectors.dll" />
				<File Id="a27" Source="$(var.Agent_Service_TargetDir)\System.Numerics.Vectors.xml" />
				<File Id="a28" Source="$(var.Agent_Service_TargetDir)\System.Runtime.CompilerServices.Unsafe.dll" />
				<File Id="a29" Source="$(var.Agent_Service_TargetDir)\System.Runtime.CompilerServices.Unsafe.xml" />
				<File Id="a30" Source="$(var.Agent_Service_TargetDir)\System.Text.Encodings.Web.dll" />
				<File Id="a31" Source="$(var.Agent_Service_TargetDir)\System.Text.Encodings.Web.xml" />
				<File Id="a32" Source="$(var.Agent_Service_TargetDir)\System.Text.Json.dll" />
				<File Id="a33" Source="$(var.Agent_Service_TargetDir)\System.Text.Json.xml" />
				<File Id="a34" Source="$(var.Agent_Service_TargetDir)\System.Threading.Tasks.Extensions.dll" />
				<File Id="a35" Source="$(var.Agent_Service_TargetDir)\System.Threading.Tasks.Extensions.xml" />
				<File Id="a36" Source="$(var.Agent_Service_TargetDir)\System.ValueTuple.dll" />
				<File Id="a37" Source="$(var.Agent_Service_TargetDir)\System.ValueTuple.xml" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="PostInstallation" Directory="AGENTFOLDER">
			<Component Id="s0" Guid="868F4F33-6851-4169-B814-F25842A2D414" Win64="yes">
				<File Id='AgentEXE' Name='IvsAgent' DiskId='1' Source='$(var.IvsAgent.TargetPath)' KeyPath='yes'/>
				<ServiceInstall Id="s1" Name="IvsAgent" DisplayName="Invinsense 3.0" Description="Invinsense Service" ErrorControl="normal" Start="auto" Type="ownProcess" />
				<ServiceControl Id="s2" Name="IvsAgent" Start="install" Stop="both" Remove="both" Wait="yes" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="TrayComponents" Directory="TRAYFOLDER">
			<Component Id="b00" Guid="7E588662-AE80-401C-B2DE-29BB4CF1ECF3" Win64="yes">
				<File Id="b02" Source="$(var.Tray_Application_TargetDir)\event_descriptions.json" />
				<File Id="b03" Source="$(var.Tray_Application_TargetDir)\Common.dll" />
				<File Id="b04" Source="$(var.Tray_Application_TargetDir)\Common.dll.config" />
				<File Id="b05" Source="$(var.Tray_Application_TargetDir)\Common.pdb" />
				<File Id="b06" Source="$(var.IvsTray.TargetPath)" />
				<File Id="b07" Source="$(var.Tray_Application_TargetDir)\IvsTray.exe.config" />
				<File Id="b08" Source="$(var.Tray_Application_TargetDir)\IvsTray.pdb" />
				<File Id="b09" Source="$(var.Tray_Application_TargetDir)\LiteDB.dll" />
				<File Id="b10" Source="$(var.Tray_Application_TargetDir)\LiteDB.xml" />
				<File Id="b11" Source="$(var.Tray_Application_TargetDir)\Microsoft.Bcl.AsyncInterfaces.dll" />
				<File Id="b12" Source="$(var.Tray_Application_TargetDir)\Microsoft.Bcl.AsyncInterfaces.xml" />
				<File Id="b17" Source="$(var.Tray_Application_TargetDir)\Serilog.dll" />
				<File Id="b18" Source="$(var.Tray_Application_TargetDir)\Serilog.Sinks.File.dll" />
				<File Id="b19" Source="$(var.Tray_Application_TargetDir)\Serilog.Sinks.File.pdb" />
				<File Id="b22" Source="$(var.Tray_Application_TargetDir)\System.Buffers.dll" />
				<File Id="b23" Source="$(var.Tray_Application_TargetDir)\System.Buffers.xml" />
				<File Id="b24" Source="$(var.Tray_Application_TargetDir)\System.Memory.dll" />
				<File Id="b25" Source="$(var.Tray_Application_TargetDir)\System.Memory.xml" />
				<File Id="b26" Source="$(var.Tray_Application_TargetDir)\System.Numerics.Vectors.dll" />
				<File Id="b27" Source="$(var.Tray_Application_TargetDir)\System.Numerics.Vectors.xml" />
				<File Id="b28" Source="$(var.Tray_Application_TargetDir)\System.Runtime.CompilerServices.Unsafe.dll" />
				<File Id="b29" Source="$(var.Tray_Application_TargetDir)\System.Runtime.CompilerServices.Unsafe.xml" />
				<File Id="b30" Source="$(var.Tray_Application_TargetDir)\System.Text.Encodings.Web.dll" />
				<File Id="b31" Source="$(var.Tray_Application_TargetDir)\System.Text.Encodings.Web.xml" />
				<File Id="b32" Source="$(var.Tray_Application_TargetDir)\System.Text.Json.dll" />
				<File Id="b33" Source="$(var.Tray_Application_TargetDir)\System.Text.Json.xml" />
				<File Id="b34" Source="$(var.Tray_Application_TargetDir)\System.Threading.Tasks.Extensions.dll" />
				<File Id="b35" Source="$(var.Tray_Application_TargetDir)\System.Threading.Tasks.Extensions.xml" />
				<File Id="b36" Source="$(var.Tray_Application_TargetDir)\System.ValueTuple.dll" />
				<File Id="b37" Source="$(var.Tray_Application_TargetDir)\System.ValueTuple.xml" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="ToolComponents" Directory="ARTIFACTSFOLDER">
			<Component Id="c00" Guid="DEF1F99A-A721-4F70-87BC-92E13E47B0B1" Win64="yes">
				<File Id="c01" Source="..\artifacts\LiteDB.Studio.exe" />
				<File Id="c02" Source="..\artifacts\Sysmon\Sysmon64.exe" />
				<File Id="c03" Source="..\artifacts\osquery-5.5.1.msi" />
			</Component>
		</ComponentGroup>
	</Fragment>
	
</Wix>
